# This script is designed to run on WSL (Windows Subsystem for Linux)
# and Debian-based Linux distributions.
#!/usr/bin/env bash

# Author: David (Davo) Faulkner
# Date Created: 01/19/2026
# Date Modified: 01/20/2026

# Description:
# This script automates the standard maintenance cycle for Debian-based 
# distributions and WSL environments. It utilizes Bash strict mode for 
# robust error handling and implements a conditional logic flow that 
# executes upgrades only when upstream changes are detected. Maintenance 
# artifacts and logs are captured for auditability.

# Usage:
# ud

# Set strict mode for script: exit on error, undefined variables, and pipe failure.
set -euo pipefail

# Define log directory path
log_dir="$HOME/ud_logs"

# Conditional: Create the log directory if it does not already exist.
# The -d flag checks for the existence of a directory.
if [ ! -d "$log_dir" ]; then
    mkdir "$log_dir"
fi

echo "Updating local cache..."

# 1. Resynchronize the package index files from their sources via the 
# network. This updates the local database of available software versions.
# Output is mirrored to update_log.txt and parsed for the update status string.
upgradable=$(sudo apt update 2>/dev/null | tee "$log_dir/update_log.txt" | grep 'All packages are up to date.')

# 2. Check if there are any packages available for upgrade.
# Logic: If the 'upgradable' variable contains the success string from the 
# update command, the upgrade process is bypassed to maintain efficiency.
if [ upgradable='All packages are up to date.' ]; then
    echo $upgradable
    echo "Upgrade skipped."
else
    echo "Updates found."
    echo "Proceeding with upgrade..."
    sudo apt upgrade -y 1> "$log_dir/upgrade_log.txt" 2> /dev/null
    echo "Upgrade complete."
fi

# 3. Remove packages that were automatically installed to satisfy 
# dependencies for other packages and are now no longer needed.
# This cleans up orphaned libraries and tools to maintain a minimalist system.
echo "Removing any orphaned libraries and tools."
sudo apt autoremove 1> "$log_dir/autoremove_log.txt" 2> /dev/null
echo "Access log files at ~/ud_logs"
echo "Update complete."
