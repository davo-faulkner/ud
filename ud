# This script is designed to run on WSL (Windows Subsystem for Linux)
# and Debian-based Linux distributions.
#!/usr/bin/env bash

# Author: David (Davo) Faulkner
# Date Created: 01/19/2026
# Date Modified: 01/22/2026

# Description:
# This script automates the standard maintenance cycle for Debian-based 
# distributions and WSL environments. It utilizes Bash strict mode for 
# robust error handling and implements a numerical logic flow that 
# executes upgrades only when a non-zero count of upgradable packages 
# is detected. Maintenance artifacts and logs are captured for auditability.

# Usage:
# ud

# Set strict mode for script: exit on error, undefined variables, and pipe failure.
set -euo pipefail

# Define log directory path
log_dir="$HOME/ud_logs"

# Conditional: Create the log directory if it does not already exist.
# The -d flag checks for the existence of a directory.
if [ ! -d "$log_dir" ]; then
    mkdir "$log_dir"
fi

echo "Updating local cache..."

# 1. Resynchronize the package index files from their sources. 
# Output is redirected to a log file within the managed log directory.
sudo apt update 1> "$log_dir/update_log.txt" 2>/dev/null

# 2. Extract the number of available upgrades by counting occurrences 
# of the "upgradable from:" string in the 'apt list' output.
# '|| true' ensures strict mode doesn't exit if the count is 0.
upgrade_count=$(apt list --upgradable 2>/dev/null | grep -i -c "upgradable from:" || true)

# 3. Conditional Upgrade Logic:
# If the upgrade_count is greater than 0, the upgrade process is executed.
# Otherwise, the upgrade is bypassed to maintain system efficiency.
if [ "$upgrade_count" -gt 0 ]; then
    echo "$upgrade_count updates found. Proceeding with upgrade..."
    sudo apt upgrade -y 1> "$log_dir/upgrade_log.txt" 2> /dev/null
    echo "Upgrade complete."
else
    echo "0 updates found. Your system is current."
    echo "Upgrade skipped."
fi

# 4. Remove packages that were automatically installed to satisfy 
# dependencies for other packages and are now no longer needed.
# This cleans up orphaned libraries to maintain a minimalist system.
echo "Removing any orphaned libraries and tools."
sudo apt autoremove 1> "$log_dir/autoremove_log.txt" 2> /dev/null

echo "Access log files at ~/ud_logs"
echo "Update complete."
